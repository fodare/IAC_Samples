trigger:
- main

pool:
  name: Default
  #vmImage: ubuntu-latest

variables:
  projectRoot: '$(System.DefaultWorkingDirectory)/Azure_DevOps_Func'

stages:
- stage: Build
  jobs:
  - job: clean
    displayName: Clean agent build DIR
    workspace:
      clean: all
  
  - job: buildapp 
    displayName: Build and restore app
    steps:
    - script: |
        dotnet restore
        dotnet build --configuration Release
      workingDirectory: $(projectRoot)
  
  - job: publishapp
    dependsOn: buildapp
    displayName: Publish and zip application project file
    steps:
    # - task: DotNetCoreCLI@2
    #   inputs:
    #     command: 'publish'
    #     publishWebProjects: false
    #     projects: '*.csproj'
    #     arguments: '--configuration Release'
    #     zipAfterPublish: false
    #     modifyOutputPath: false
    #     workingDirectory: '$(System.DefaultWorkingDirectory)/Azure_DevOps_Func'
    
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/Azure_DevOps_Func'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
        replaceExistingArchive: true
        verbose: true

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
        ArtifactName: 'drop'
        publishLocation: 'Container'
    
    - task: AzureFunctionApp@2
      inputs:
        connectedServiceNameARM: 'Az_SVC_Connection'
        appType: 'functionAppLinux'
        appName: 'azure-devOps-func'
        package: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
        runtimeStack: 'DOTNET-ISOLATED|7.0'
        deploymentMethod: 'runFromPackage'
        

# - stage: Deploy
#   dependsOn: Build
#   jobs:
#     - job: 
#       displayName: Download build artifacts
#       steps:
#         - task: DownloadBuildArtifacts@1
#           inputs:
#             buildType: 'current'
#             downloadType: 'single'
#             artifactName: 'drop'
#             downloadPath: '$(System.ArtifactsDirectory)'
#             cleanDestinationFolder: true
    
#     - job: Deployapp
#       displayName: Update AZ function
#       steps:
#       - task: AzureFunctionApp@2
#         inputs:
#           connectedServiceNameARM: 'Az_SVC_Connection'
#           appType: 'functionAppLinux'
#           appName: 'azure-devOps-func'
#           package: '$(System.ArtifactsDirectory)'
#           runtimeStack: 'DOTNET-ISOLATED|7.0'
#           deploymentMethod: 'zipDeploy'


      # - task: AzureCLI@2
      #   displayName: AZ SP Login
      #   inputs:
      #     azureSubscription: 'Az_SVC_Connection'
      #     scriptType: 'bash'
      #     scriptLocation: 'inlineScript'
      #     inlineScript: 'az login --service-principal -u $(SP_USERNAME) -p $(SP_PASSWORD) --tenant $(SP_TENANTID)'
      #     useGlobalConfig: true
      #     failOnStandardError: true

      # - task: AzureCLI@2
      #   inputs:
      #     azureSubscription: 'Az_SVC_Connection'
      #     scriptType: 'bash'
      #     scriptLocation: 'inlineScript'
      #     inlineScript: 'func azure functionapp publish azure-devOps-func --csharp -b remote'
      #     workingDirectory: '$(System.DefaultWorkingDirectory)/Azure_DevOps_Func'

      